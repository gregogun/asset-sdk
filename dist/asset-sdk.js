var t=require("zod"),e=require("arweave"),n=require("@bundlr-network/client"),r=require("warp-contracts"),a=require("uuid"),o=require("ramda"),i=require("fpjson-lang");function s(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var u=/*#__PURE__*/s(e),c=/*#__PURE__*/s(n),p=/*#__PURE__*/s(i),l=t.z.object({arweave:t.z.instanceof(u.default),bundlr:t.z.instanceof(c.default),warp:t.z.instanceof(r.Warp),warpCacheURL:t.z.string().default("https://cache.permapages.app"),wallet:t.z.any(),contracts:t.z.object({stamp:t.z.string().default("FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA"),bar:t.z.string().default("VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA"),vouchdao:t.z.string().default("_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk")}).default({stamp:"FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA",bar:"VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA",vouchdao:"_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk"}),sources:t.z.object({asset:t.z.string().default("x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs")}).default({asset:"x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs"})}),d=t.z.object({id:t.z.string().optional(),title:t.z.string().min(1).max(180),description:t.z.string().max(300),type:t.z.string(),topics:t.z.array(t.z.string()),balances:t.z.record(t.z.string(),t.z.number()),contentType:t.z.string().default("text/html"),data:t.z.string().or(t.z.instanceof(Uint8Array)).optional(),forks:t.z.string().optional(),groupId:t.z.string().optional(),meta:t.z.string().optional()});function f(){return f=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},f.apply(this,arguments)}function g(t,e,n){if(!t.s){if(n instanceof h){if(!n.s)return void(n.o=g.bind(null,t,e));1&e&&(e=n.s),n=n.v}if(n&&n.then)return void n.then(g.bind(null,t,e),g.bind(null,t,2));t.s=e,t.v=n;const r=t.o;r&&r(t)}}var h=/*#__PURE__*/function(){function t(){}return t.prototype.then=function(e,n){var r=new t,a=this.s;if(a){var o=1&a?e:n;if(o){try{g(r,1,o(this.v))}catch(t){g(r,2,t)}return r}return this}return this.o=function(t){try{var a=t.v;1&t.s?g(r,1,e?e(a):a):n?g(r,1,n(a)):g(r,2,a)}catch(t){g(r,2,t)}},r},t}();function m(t){return t instanceof h&&1&t.s}function v(t){return{getAsset:function(e){return function(t){return Promise.resolve({query:"query ($ids: [ID!], $cursor: String) {\n      transactions(first: 1, after: $cursor, \n        ids: $ids) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id\n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }",variables:{ids:[t]}})}(e).then(t.gql).then(b).then(function(e){return Promise.all([t.getData(e.source).catch(o.always("No meta data...")),t.getData(e.asset.id).catch(o.always("No data..."))]).then(function(t){var n=t[0],r=t[1];return f({},y(e.asset),{meta:n,data:r})})}).then(function(e){return t.stampCache(["compose",["length"],["filter",["propEq","asset",e.id]],["values"],["prop","stamps"]]).then(function(t){return o.assoc("stamps",t.result,e)})})},createAsset:function(e){return e.groupId||(e.groupId=t.randomUUID()),t.publish(function(t){var e=o.map(function(t){return{name:"Topic:"+t,value:t}},t.topics);return{target:{data:t.data,tags:[{name:"Content-Type",value:t.contentType},{name:"Title",value:t.title},{name:"Description",value:t.description},{name:"Type",value:t.type},{name:"Published",value:String(Date.now())},{name:"Page-Code",value:t.groupId},{name:"Group-Id",value:t.groupId},{name:"Init-State",value:JSON.stringify({balances:t.balances,pairs:[],name:t.type+"-"+t.groupId,ticker:t.type.toUpperCase(),settings:[["isTradeable",!0]]})}].concat(e)},meta:{data:t.meta,tags:[{name:"Content-Type",value:"text/markdown"},{name:"App-Name",value:"AssetSDK"},{name:"Title",value:t.title},{name:"Description",value:t.description},{name:"Type",value:t.type+"-meta"}]}}}(e))},stampAsset:function(e){return t.stamp(e)},getItemsByGroupId:function(e){return t.gql({query:'query ($groupIds: [String!]!, $cursor: String) {\n      transactions(first: 100, after: $cursor, tags: [\n        { name: "Group-Id", values: $groupIds }\n       ]) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id \n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }',variables:{groupIds:[e]}}).then(o.map(o.compose(y,o.prop("node"))))},getGroupGraph:function(t){}}}function y(t){var e=o.compose(o.prop("value"),function(e){return o.find(o.propEq("name",e),t.tags)}),n=e("Published")?Number(e("Published")):Date.now(),r=o.join(", ",o.pluck("value",o.filter(function(t){return/^Topic:/.test(t.name)},t.tags)));return{id:t.id,type:e("Type"),title:e("Title"),description:e("Description"),meta:e("META"),groupId:e("Group-Id"),published:n,stamps:0,topics:r}}function b(t){return{source:t[0].node.tags.find(o.propEq("name","META")).value,asset:t[0].node}}module.exports={init:function(t){var e=function(t){var e=function(e){try{return Promise.resolve(t.bundlr.upload(e.data,{tags:e.tags}))}catch(t){return Promise.reject(t)}};return{randomUUID:function(){return a.v4()},publish:function(n){return e(n.meta).then(function(r){return n.target.tags=[].concat(n.target.tags,[{name:"META",value:r.id},{name:"App-Name",value:"SmartWeaveContract"},{name:"App-Version",value:"0.3.0"},{name:"Contract-Src",value:t.sources.asset}]),e(n.target)}).then(function(e){return function(e){try{return Promise.resolve(t.warp.register(e,"node2")).then(function(t){return{id:t.contractTxId}})}catch(t){return Promise.reject(t)}}(e.id)})},getData:function(e){return t.arweave.api.get(e).then(o.prop("data"))},gql:function(e){try{var n=!0,r=[],a="",i=function(t,e,n){for(var r;;){var a=t();if(m(a)&&(a=a.v),!a)return o;if(a.then){r=0;break}var o=n();if(o&&o.then){if(!m(o)){r=1;break}o=o.s}}var i=new h,s=g.bind(null,i,2);return(0===r?a.then(c):1===r?o.then(u):(void 0).then(function(){(a=t())?a.then?a.then(c).then(void 0,s):c(a):g(i,1,o)})).then(void 0,s),i;function u(e){o=e;do{if(!(a=t())||m(a)&&!a.v)return void g(i,1,o);if(a.then)return void a.then(c).then(void 0,s);m(o=n())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,s)}function c(t){t?(o=n())&&o.then?o.then(u).then(void 0,s):u(o):g(i,1,o)}}(function(){return!!n},0,function(){return Promise.resolve((i={query:e.query,variables:f({},e.variables,{cursor:a})},t.arweave.api.post("graphql",i).then(function(t){if(t.data.errors)throw new Error(JSON.stringify(t.data.errors,null,2));return t}).then(o.path(["data","data","transactions"])))).then(function(t){t.edges&&t.edges.length&&(r=r.concat(t.edges),a=t.edges[t.edges.length-1].cursor),n=t.pageInfo.hasNextPage});var i});return Promise.resolve(i&&i.then?i.then(function(){return r}):r)}catch(t){return Promise.reject(t)}},stampCache:function(e){return fetch(t.warpCacheURL+"/"+t.contracts.stamp,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e)}).then(function(n){return n.ok?n.json():t.warp.contract(t.contracts.stamp).connect(t.wallet).setEvaluationOptions({internalWrites:!0,allowBigInt:!0}).readState().then(function(t){return p.default([e,t.cachedValue.state])})})},stamp:function(t){}}}(t=l.parse(t));return{create:function(t){return t=d.parse(t),v(e).createAsset(t)},get:function(t){return v(e).getAsset(t)},stamp:function(t){return v(e).stampAsset(t)},list:function(t){return v(e).getItemsByGroupId(t)}}}};
//# sourceMappingURL=asset-sdk.js.map
