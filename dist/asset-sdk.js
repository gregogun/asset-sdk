var e=require("zod"),t=require("arweave"),n=require("@bundlr-network/client"),r=require("warp-contracts"),a=require("uuid"),o=require("ramda"),s=require("fpjson-lang");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var u=/*#__PURE__*/i(t),c=/*#__PURE__*/i(n),p=/*#__PURE__*/i(s),l=e.z.object({arweave:e.z.instanceof(u.default),bundlr:e.z.instanceof(c.default),warp:e.z.instanceof(r.Warp),warpCacheURL:e.z.string().default("https://cache.permapages.app"),wallet:e.z.any(),contracts:e.z.object({stamp:e.z.string().default("FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA"),bar:e.z.string().default("VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA"),vouchdao:e.z.string().default("_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk")}).default({stamp:"FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA",bar:"VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA",vouchdao:"_z0ch80z_daDUFqC9jHjfOL8nekJcok4ZRkE_UesYsk"}),sources:e.z.object({asset:e.z.string().default("x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs")}).default({asset:"x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs"})}),d=e.z.object({id:e.z.string().optional(),title:e.z.string().min(1).max(180),description:e.z.string().max(300),type:e.z.string(),topics:e.z.array(e.z.string()),balances:e.z.record(e.z.string(),e.z.number()),content:e.z.string().optional(),contentType:e.z.string().default("text/html"),html:e.z.string().optional(),forks:e.z.string().optional(),groupId:e.z.string().optional(),meta:e.z.string().optional()});function f(){return f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f.apply(this,arguments)}function g(e,t,n){if(!e.s){if(n instanceof m){if(!n.s)return void(n.o=g.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(g.bind(null,e,t),g.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}var m=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,a=this.s;if(a){var o=1&a?t:n;if(o){try{g(r,1,o(this.v))}catch(e){g(r,2,e)}return r}return this}return this.o=function(e){try{var a=e.v;1&e.s?g(r,1,t?t(a):a):n?g(r,1,n(a)):g(r,2,a)}catch(e){g(r,2,e)}},r},e}();function h(e){return e instanceof m&&1&e.s}var v=o.find(o.compose(o.propEq("value","source"),o.find(o.propEq("name","Type")),o.prop("tags"))),y=function(e){return o.find(o.compose(o.propEq("value",e),o.find(o.propEq("name","Type")),o.prop("tags")))};function b(e){return{getAsset:function(t,n){return function(e,t){return Promise.resolve({query:'query ($ids: [ID!], $cursor: String, $type: String!) {\n      transactions(first: 3, after: $cursor, \n        ids: $ids,\n        tags: [\n          { name: "Type", values: [$type] }\n        ]) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id\n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }',variables:{ids:[e],type:t}})}(t,n).then(e.gql).then(function(e){return function(t){return{source:o.compose(v,o.pluck("node"))(t),asset:o.compose(y(e),o.pluck("node"))(t)}}}(n)).then(function(t){return Promise.all([t.source?e.getData(t.asset.meta):Promise.resolve("No Source Found."),t.asset?e.getData(t.asset.id):Promise.resolve("No Content Found")]).then(function(e){var n=e[0],r=e[1];return f({},z(t.asset),{content:n,html:r})})}).then(function(t){return e.stampCache(["compose",["length"],["filter",["propEq","asset",t.id]],["values"],["prop","stamps"]]).then(function(e){return o.assoc("stamps",e.result,t)})})},createAsset:function(t){return t.groupId||(t.groupId=e.randomUUID()),e.publish(function(e){var t=o.map(function(e){return{name:"Topic:"+e,value:e}},e.topics);return{target:{data:e.html,tags:[{name:"Content-Type",value:e.contentType},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:e.type},{name:"Published",value:String(Date.now())},{name:"Page-Code",value:e.groupId},{name:"Group-Id",value:e.groupId},{name:"Init-State",value:JSON.stringify({balances:e.balances,pairs:[],name:e.type+"-"+e.groupId,ticker:e.type.toUpperCase(),settings:[["isTradeable",!0]]})}].concat(t)},meta:{data:e.content,tags:[{name:"Content-Type",value:"text/markdown"},{name:"App-Name",value:"AssetSDK"},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:e.type+"-meta"}]}}}(t))},stampAsset:function(t){return e.stamp(t)},getItemsByGroupId:function(t,n){return e.gql({query:'query ($groupIds: [String!]!, $cursor: String, $types: [String!]!) {\n      transactions(first: 100, after: $cursor, tags: [\n        { name: "Group-Id", values: $groupIds },\n        { name: "Type", values: $types}\n       ]) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id \n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }',variables:{groupIds:[t],types:[n]}}).then(o.map(o.compose(z,o.prop("node"))))}}}function z(e){var t=o.compose(o.prop("value"),function(t){return o.find(o.propEq("name",t),e.tags)}),n=t("Published")?Number(t("Published")):Date.now(),r=o.join(", ",o.pluck("value",o.filter(function(e){return/^Topic:/.test(e.name)},e.tags)));return{id:e.id,type:t("Type"),title:t("Title"),description:t("Description"),meta:t("META"),published:n,stamps:0,topics:r}}module.exports={init:function(e){var t=function(e){var t=function(t){try{return Promise.resolve(e.bundlr.upload(t.data,{tags:t.tags}))}catch(e){return Promise.reject(e)}};return{randomUUID:function(){return a.v4()},publish:function(n){return t(n.meta).then(function(r){return n.target.tags=[].concat(n.target.tags,[{name:"META",value:r.id},{name:"App-Name",value:"SmartWeaveContract"},{name:"App-Version",value:"0.3.0"},{name:"Contract-Src",value:e.sources.asset}]),t(n.target)}).then(function(t){return function(t){try{return Promise.resolve(e.warp.register(t,"node2")).then(function(e){return{id:e.contractTxId}})}catch(e){return Promise.reject(e)}}(t.id)})},getData:function(t){return e.arweave.api.get(t).then(o.prop("data"))},gql:function(t){try{var n=!0,r=[],a="",s=function(e,t,n){for(var r;;){var a=e();if(h(a)&&(a=a.v),!a)return o;if(a.then){r=0;break}var o=n();if(o&&o.then){if(!h(o)){r=1;break}o=o.s}}var s=new m,i=g.bind(null,s,2);return(0===r?a.then(c):1===r?o.then(u):(void 0).then(function(){(a=e())?a.then?a.then(c).then(void 0,i):c(a):g(s,1,o)})).then(void 0,i),s;function u(t){o=t;do{if(!(a=e())||h(a)&&!a.v)return void g(s,1,o);if(a.then)return void a.then(c).then(void 0,i);h(o=n())&&(o=o.v)}while(!o||!o.then);o.then(u).then(void 0,i)}function c(e){e?(o=n())&&o.then?o.then(u).then(void 0,i):u(o):g(s,1,o)}}(function(){return!!n},0,function(){return Promise.resolve((s={query:t.query,variables:f({},t.variables,{cursor:a})},e.arweave.api.post("graphql",s).then(function(e){if(e.data.errors)throw new Error(JSON.stringify(e.data.errors,null,2));return e}).then(o.path(["data","data","transactions"])))).then(function(e){e.edges&&e.edges.length&&(r=r.concat(e.edges),a=e.edges[e.edges.length-1].cursor),n=e.pageInfo.hasNextPage});var s});return Promise.resolve(s&&s.then?s.then(function(){return r}):r)}catch(e){return Promise.reject(e)}},stampCache:function(t){return fetch(e.warpCacheURL+"/"+e.contracts.stamp,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(t)}).then(function(n){return n.ok?n.json():e.warp.contract(e.contracts.stamp).connect(e.wallet).setEvaluationOptions({internalWrites:!0,allowBigInt:!0}).readState().then(function(e){return p.default([t,e.cachedValue.state])})})},stamp:function(e){}}}(e=l.parse(e));return{create:function(e){return e=d.parse(e),b(t).createAsset(e)},get:function(e,n){return b(t).getAsset(e,n)},stamp:function(e){return b(t).stampAsset(e)},list:function(e,n){return b(t).getItemsByGroupId(e,n)}}}};
//# sourceMappingURL=asset-sdk.js.map
