var e=require("zod"),t=require("arweave"),n=require("@bundlr-network/client"),r=require("uuid"),a=require("ramda");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var o=/*#__PURE__*/i(t),s=/*#__PURE__*/i(n),u=e.z.object({arweave:e.z.instanceof(o.default),bundlr:e.z.instanceof(s.default),contracts:e.z.object({stamp:e.z.string().default("FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA"),bar:e.z.string().default("VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA")}).default({stamp:"FMRHYgSijiUNBrFy-XqyNNXenHsCV0ThR4lGAPO4chA",bar:"VFr3Bk-uM-motpNNkkFg4lNW1BMmSfzqsVO551Ho4hA"}),sources:e.z.object({asset:e.z.string().default("x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs")}).default({asset:"x0ojRwrcHBmZP20Y4SY0mgusMRx-IYTjg5W8c3UFoNs"})}),c=e.z.object({id:e.z.string().optional(),title:e.z.string().min(1).max(180),description:e.z.string().max(300),type:e.z.string(),topics:e.z.array(e.z.string()),balances:e.z.record(e.z.string(),e.z.number()),content:e.z.string().optional(),html:e.z.string().optional(),forks:e.z.string().optional(),appId:e.z.string().optional()});function l(){return l=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},l.apply(this,arguments)}function p(e,t,n){if(!e.s){if(n instanceof d){if(!n.s)return void(n.o=p.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(p.bind(null,e,t),p.bind(null,e,2));e.s=t,e.v=n;const r=e.o;r&&r(e)}}var d=/*#__PURE__*/function(){function e(){}return e.prototype.then=function(t,n){var r=new e,a=this.s;if(a){var i=1&a?t:n;if(i){try{p(r,1,i(this.v))}catch(e){p(r,2,e)}return r}return this}return this.o=function(e){try{var a=e.v;1&e.s?p(r,1,t?t(a):a):n?p(r,1,n(a)):p(r,2,a)}catch(e){p(r,2,e)}},r},e}();function f(e){return e instanceof d&&1&e.s}var v=a.find(a.compose(a.propEq("value","source"),a.find(a.propEq("name","Type")),a.prop("tags"))),m=function(e){return a.find(a.compose(a.propEq("value",e),a.find(a.propEq("name","Type")),a.prop("tags")))};function g(e){return{getAsset:function(t,n){return function(e,t){return Promise.resolve({query:'query ($ids: [String!]!, $cursor: String, $type: String!) {\n      transactions(first: 3, after: $cursor, \n        tags: [\n          { name: "Type", values: [$type] },\n          { name: "Asset-Id", values: $ids }\n        ]) {\n        pageInfo {\n          hasNextPage\n        }\n        edges {\n          cursor\n          node {\n            id\n            tags {\n              name\n              value\n            }\n          }\n        }\n      }\n    }',variables:{ids:[e],type:t}})}(t,n).then(e.gql).then(function(e){return function(t){return{source:a.compose(v,a.pluck("node"))(t),asset:a.compose(m(e),a.pluck("node"))(t)}}}(n)).then(function(t){return Promise.all([t.source?e.getData(t.source.id):Promise.resolve("No Source Found."),t.asset?e.getData(t.asset.id):Promise.resolve("No Content Found")]).then(function(e){var n,r,i,o,s=e[0],u=e[1];return l({},(n=t.asset,i=(r=a.compose(a.prop("value"),function(e){return a.find(a.propEq("name",e),n.tags)}))("Published")?Number(r("Published")):Date.now(),o=a.join(", ",a.pluck("value",a.filter(function(e){return/^Topic:/.test(e.name)},n.tags))),{id:r("Asset-Id"),type:r("Type"),title:r("Title"),description:r("Description"),transaction:n.id,published:i,stamps:0,topics:o}),{content:s,html:u})})})},createAsset:function(t){return t.id||(t.id=e.randomUUID()),e.publish(function(e){var t=a.map(function(e){return{name:"Topic:"+e,value:e}},e.topics);return{id:e.id,asset:{data:e.html,tags:[{name:"Content-Type",value:"text/html"},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:"app"},{name:"Published",value:String(Date.now())},{name:"Asset-Id",value:e.id},{name:"Page-Code",value:e.id},{name:"App-Id",value:e.appId},{name:"Init-State",value:JSON.stringify({balances:e.balances,pairs:[],name:"App-"+e.id,ticker:"APP",settings:[["isTradeable",!0]]})}].concat(t)},source:{data:e.content,tags:[{name:"Content-Type",value:"text/markdown"},{name:"App-Name",value:"AssetSDK"},{name:"Title",value:e.title},{name:"Description",value:e.description},{name:"Type",value:"source"},{name:"Asset-Id",value:e.id}]}}}(t))}}}module.exports={init:function(e){var t=function(e){var t=function(t){try{return Promise.resolve(e.bundlr.upload(t.data,{tags:t.tags}))}catch(e){return Promise.reject(e)}};return{randomUUID:function(){return r.v4()},publish:function(n){return n.asset.tags=a.concat([{name:"App-Name",value:"SmartWeaveContract"},{name:"App-Version",value:"0.3.0"},{name:"Contract-Src",value:e.sources.asset}],n.asset.tags),t(n.source).then(function(){return t(n.asset)})},getData:function(t){return e.arweave.api.get(t).then(a.prop("data"))},gql:function(t){try{var n=!0,r=[],i="",o=function(e,t,n){for(var r;;){var a=e();if(f(a)&&(a=a.v),!a)return i;if(a.then){r=0;break}var i=n();if(i&&i.then){if(!f(i)){r=1;break}i=i.s}}var o=new d,s=p.bind(null,o,2);return(0===r?a.then(c):1===r?i.then(u):(void 0).then(function(){(a=e())?a.then?a.then(c).then(void 0,s):c(a):p(o,1,i)})).then(void 0,s),o;function u(t){i=t;do{if(!(a=e())||f(a)&&!a.v)return void p(o,1,i);if(a.then)return void a.then(c).then(void 0,s);f(i=n())&&(i=i.v)}while(!i||!i.then);i.then(u).then(void 0,s)}function c(e){e?(i=n())&&i.then?i.then(u).then(void 0,s):u(i):p(o,1,i)}}(function(){return!!n},0,function(){return Promise.resolve((o={query:t.query,variables:l({},t.variables,{cursor:i})},e.arweave.api.post("graphql",o).then(a.path(["data","data","transactions"])))).then(function(e){e.edges&&e.edges.length&&(r=r.concat(e.edges),i=e.edges[e.edges.length-1].cursor),n=e.pageInfo.hasNextPage});var o});return Promise.resolve(o&&o.then?o.then(function(){return r}):r)}catch(e){return Promise.reject(e)}}}}(e=u.parse(e));return{create:function(e){return e=c.parse(e),g(t).createAsset(e)},get:function(e,n){return g(t).getAsset(e,n)}}}};
//# sourceMappingURL=asset-sdk.js.map
